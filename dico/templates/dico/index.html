<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>I Do Declare</title>

    <!-- Bootstrap -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "dico/css/dicopage.css" %}" rel="stylesheet">
    <link href="{% static "dico/css/index.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Scripts for data mapping --!>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>

	<!-- Styles for this web page -->
	<style>
		<!-- Account for bottom navigation bar -->
		body {
		  padding-bottom: 55px;
		}
	</style>


  </head>
  <body class="dico-two-nav-container">

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">

		var stateCodes = ["", 
			"AL", "AK", "AS", "AZ", "AR", "CA", "??", "CO", "CT", "DE", 
			"DC", "FL", "GA", "GU", "HI", "ID", "IL", "IN", "IA", "KS", 
			"KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", 
			"NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", 
			"OR", "PA", "PR", "RI", "SC", "SD", "TN", "TX", "UT", "VT", 
			"VA", "VI", "WA", "WV", "WI", "WY"];
			
		var districtScope = "district",
			stateScope = "state";
		
		
		function htmlDecode(input){
		  var e = document.createElement('div');
		  e.innerHTML = input;
		  return e.childNodes[0].nodeValue;
		}

		$(document).ready (function() {
			$("#id_accountSettingsLink").attr("href", "{% url 'account' %}?back="+window.location.href);
			$("#id_changePasswordLink").attr("href", "{% url 'password' %}?back="+window.location.href);

			initmap();
			
			show_issue_map();

			addHandlers();
		});

		$(window).resize(function() {
		  	resize_map();
		});
		
		function initmap() {
			// Initialize the map.
			var width = $("#mapFrame").width();
			var height = width / 8 * 5;
			if (height > window.innerHeight - 110) {
				height = window.innerHeight - 110;
				width = height / 5 * 8;
			}
			
		
			function ready(error, us) {
			  if (error) return console.error(error);

				var projection = d3.geo.albersUsa()
					.scale(width * 4 / 3)
					.translate([width / 2, height / 2]);

				var path = d3.geo.path()
					.projection(projection);

				// add the path for all of the us land.
				svg.append("defs").append("path")
				  .attr("id", "land")
				  .datum(topojson.feature(us, us.objects.land))
				  .attr("d", path);

				svg.append("clipPath")
				  .attr("id", "clip-land")
				  .append("use")
					.attr("xlink:href", "#land");
					
				svg.append("g")
				  .attr("class", "land")
				  .attr("clip-path", "url(#clip-land)");
			}

			svg = d3.select("#mapFrame").append("svg")
				.attr("width", width)
				.attr("height", height);
				
			// json files for us state map and us districts map taken from https://gist.github.com/mbostock/4090846
			queue()
				.defer(d3.json, "{% static "dico/us.json" %}")
				.await(ready);
		}
		
		function resetCircles() { 
		  	if ($("#byDistrictRadio").prop("checked")) { 
		  		change_issue($("#issue_select").val(), districtScope);
		  	} else {
		  		change_issue($("#issue_select").val(), stateScope);
		  	}
		  }

		function addHandlers() {
		  $("#issue_select").change( function() { resetCircles() });
		  $("#byDistrictRadio").change( function() {
		  	show_map($("#issue_select").val(), districtScope);
		  });
		  $("#byStateRadio").change( function() { 
		  	show_map($("#issue_select").val(), stateScope);
		  });
		}
		

		function change_issue(newIssue, newScope) {
		  $.getJSON("{% url 'getIssueInterests' %}", { pk: newIssue, scope : newScope}, function(json){
			var s = "";
			if (json['error']) {
				s = json['error'];
			} else {
				var interests = json['interests'];
				var countMax = d3.max(interests, function(d) {return d.constituent_count; })
		
				if (countMax < 10) { countMax = 10; }
		
				var svg = d3.select("#mapFrame").select("svg");
				var circles = svg.selectAll(".bubble");
		
				rScale = d3.scale.linear()
							.domain([0, countMax])
							.range([0, 30]);

				// Clear the radii of all of the circles.
				circles.attr("r", 0);
		
				for (i = 0; i < interests.length; ++i) {
					var interest = interests[i];
					var interestID;
					
					if (newScope == districtScope) {
						s = s + interest['state'] + "-" + interest['district'] + ": " + interest['constituent_count'] + "<br>"
						// Handle the special case for 'DC' here. The case for states with only one district
						// is handled elsewhere.
						if (interest['state'] == 'DC') {
							interestID=100*stateCodes.indexOf(interest['state']) + 98;
						} else {
							interestID=100*stateCodes.indexOf(interest['state']) + interest['district'];
						}
					}
					else {
						s = s + interest['state'] + ": " + interest['constituent_count'] + "<br>"
						interestID=stateCodes.indexOf(interest['state']);
					}

					var ba = circles.filter(function() { return (this.getAttribute("id")==interestID);})
					if (ba.size() == 0 && newScope == districtScope && interest['district'] == 1) {
						ba = circles.filter(function() { return (this.getAttribute("id")==interestID-1);})
					}
					if (ba.size() > 0) {
						ba[0][0].setAttribute("r", rScale(interest['constituent_count']));
					}
				}
			}
			$("#my_score").html('').append(s);
		  });
		}

		function htmlEncode(input){
			str = $('<div>').text(input).html();
		    return String(str).replace(/ /g, '&nbsp;');
		}
		
		function show_my_interests() {
		  $.post("{% url 'getMyInterests' %}", { csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
			
			{% if user.is_authenticated %}
				$("#my_interests").empty();
				ul = document.createElement( "tbody" );
				$("#my_interests").append(ul);
				
				var issues = json['myIssues'];
				for (i = 0; i < issues.length; ++i) {
					issue = issues[i];
					tr = document.createElement("tr");
					td1 = document.createElement("td");
					td2 = document.createElement("td");
					newButton = document.createElement("a");
					$(ul).append(tr);
					$(tr).append(td1)
						 .append(td2);
					$(td1).append(newButton);
					$(newButton).addClass("btn btn-link btn-xs")
								.attr("href", "/dico/" + issue['id'] + "/issue/")
								.append(htmlEncode(issue['name']));
					petitionCount = parseInt(issue['petition_count']);
					if (petitionCount > 0) {
						newBadge = document.createElement("span");
						$(newBadge).addClass("badge")
								   .append(petitionCount);
						$(newButton).append(" ")
								    .append(newBadge);
					}
					newButton = document.createElement("a");
					newSpan = document.createElement("span")
					$(td2).append(newButton);
					$(newButton).attr("href", "/dico/" + issue['id'] + "/issue/")
								.append(newSpan);
					$(newSpan).addClass("glyphicon glyphicon-chevron-right");
				}
			{% endif %}

			show_issue_map();
			
		  });
		}
		
		function show_issue_map() {
		  	$.getJSON("{% url 'getIssues' %}", { 'minInterestCount': 1}, function(json){
				var allIssues = json['issues'];

				selectElement = document.getElementById("issue_select")
	
				// Add an option for each issue to the select object.
				for (i = 0; i < allIssues.length; ++i) {
					newOption = document.createElement('option');
					newOption.innerHTML = allIssues[i].name;
					newOption.value = allIssues[i].id;
					selectElement.appendChild(newOption);
				}
				reset_map();
			});
		}
		
		function resize_map() {
			var width = $("#mapFrame").width();
			var height = width / 8 * 5;
			if (height > window.innerHeight - 110) {
				height = window.innerHeight - 110;
				width = height / 5 * 8;
			}

			var projection = d3.geo.albersUsa()
				.scale(width * 4 / 3)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			var svg = d3.select("#mapFrame").select("svg");

			// add the path for all of the us land.
			svg.select("defs").select("path")
			  .attr("d", path);
			
			reset_map();
		}
		
		function reset_map() {
		  	if ($("#byDistrictRadio").prop("checked")) { 
		  		show_map($("#issue_select").val(), districtScope);
		  	} else {
		  		show_map($("#issue_select").val(), stateScope);
		  	}
		}

		function show_map(newIssue, newScope) {
			var circleData = [];
	
			function mouseoverstate() {
			  stateIndex = parseInt(d3.select(this).select("title").text());
			  s = stateCodes[stateIndex]; 
			  $("#district_span").html('').append(s);
			}

			function mouseoverdistrict() {
			  thisTitle = parseInt(d3.select(this).select("title").text());
			  stateIndex = (thisTitle / 100 | 0);
			  districtIndex = thisTitle % 100;
			  s = stateCodes[stateIndex] + "-"; 
			  if (districtIndex == 0) {
				s = s + "01";
			  } else if (districtIndex < 10) {
				s = s + "0" + districtIndex;
			  } else {
				s = s + districtIndex;
			  }

			  $("#district_span").html('').append(s);
			}

			function mouseoutstate() {
			  $("#district_span").html('');
			}

			function mouseoutdistrict() {
			  $("#district_span").html('');
			}
	
			function ready(error, us, congress) {
			  if (error) return console.error(error);

			var districts = congress.objects.districts;

			var width = $("#mapFrame").width(),
				height = width / 8 * 5;
			if (height > window.innerHeight - 110) {
				height = window.innerHeight - 110;
				width = height / 5 * 8;
			}

			svg.attr("width", width)
			   .attr("height", height);
			   
			var projection = d3.geo.albersUsa()
				.scale(width * 4 / 3)
				.translate([width / 2, height / 2]);

			var path = d3.geo.path()
				.projection(projection);

			circleData = [];
	  
			// Count the circleArray positions manually in case the indexes are not continuous.
			i = 0;
			var district = svg.select("g").selectAll("path");
			
			pathNodes = null;	
			if (newScope == districtScope) {
				  pathNodes = district.data(topojson.feature(congress, districts).features)
				.enter().append("path")
				  .attr("d", path)
				  .attr("class", "district")
				  .on("mouseover", mouseoverdistrict)
				  .on("mouseout", mouseoutdistrict)
				  .each(function(d){
						// Get the centroid or, if the centroid is degenerate, the bounds.
						centroid = path.centroid(d);
						if (isNaN(centroid[0]))
							centroid = path.bounds(d);

						if (!isNaN(centroid[0])) {
							circleData[i] = {"cx": centroid[0], "cy": centroid[1], "r": 0, "id": d.id};
							i++;
						}
					});
			} else {
				  pathNodes = district.data(topojson.feature(us, us.objects.states).features)
				.enter().append("path")
				  .attr("d", path)
				  .attr("class", "state")
				  .on("mouseover", mouseoverstate)
				  .on("mouseout", mouseoutstate)
				  .each(function(d){
						// Get the centroid or, if the centroid is degenerate, the bounds.
						centroid = path.centroid(d);
						if (isNaN(centroid[0]))
							centroid = path.bounds(d);

						if (!isNaN(centroid[0])) {
							circleData[i] = {"cx": centroid[0], "cy": centroid[1], "r": 0, "id": d.id};
							i++;
						}
					});
			}

			  pathNodes
				  .append("title")
				  .text(function(d) { return d.id; });
	  
			if (newScope == districtScope) {
			  svg.append("path")
				  .attr("class", "border border--district")
				  .datum(topojson.mesh(congress, congress.objects.districts, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
				  .attr("d", path);
			}

			  svg.append("path")
				  .attr("class", "border border--state")
				  .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
				  .attr("d", path);
		  
				circles = svg.selectAll("circle")
					.data(circleData)
					.enter()
					.append("circle")
						.attr("class", "bubble")
						.attr("cx", function(d, i) { return d.cx; })
						.attr("cy", function(d) { return d.cy; })
						.attr("r", function(d) { return d.r; })
						.attr("id", function(d) { return d.id; })
						.call(function() {change_issue(newIssue, newScope); });
	  
	  			// Set the label for the object when mousing over.
	  			if (newScope == districtScope)
	  				$("#district_label").html('').append("District:");
	  			else
	  				$("#district_label").html('').append("State:");
			}

			// Remove any lingering contents from the mapFrame.
			
			var svg = d3.select("#mapFrame").select("svg");
			
			svg.selectAll(".district").remove();
			svg.selectAll(".state").remove();
			svg.selectAll(".border").remove();
			svg.selectAll(".bubble").remove();

			// json files for us state map and us districts map taken from https://gist.github.com/mbostock/4090846
			queue()
				.defer(d3.json, "{% static "dico/us.json" %}")
				.defer(d3.json, "{% static "dico/us-congress-113.json" %}")
				.await(ready);
		}

		d3.select(self.frameElement).style("height", ($("#mapFrame").width() / 8 * 5) + "px");
	</script>

	<div id='container' class="container-fluid">
		<nav class="navbar navbar-default navbar-fixed-top dico-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="nav navbar-header pull-left">
				  <div class="navbar-brand">I Do Declare</div>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				{% if user.is_authenticated %}
					<div class="nav navbar-nav navbar-header pull-right">
						<li class="dropdown">
						  <a href="#" class="dropdown-toggle navbar-link" data-toggle="dropdown">{{ user.get_full_name }}<span class="caret"></span></a>
						  <ul class="dropdown-menu dropdown-menu-right" role="menu">
							<li><a id="id_accountSettingsLink">Account Settings</a></li>
							<li><a id="id_changePasswordLink">Change Password</a></li>
							<li class="divider"></li>
							<li><a href="{% url 'editInterests' %}">Edit Interests</a></li>
							<li class="divider"></li>
							<li><a href="{% url 'signout' %}">Sign out</a></li>
						  </ul>
						</li>
					</div>
				{% else %}
					<div class="nav navbar-header pull-right">
						<a class="navbar-text navbar-link pull-right dico-navbar-text" href="{% url 'signin' %}">Sign in</a>
					</div>
				{% endif %}
			</div>
		</nav>
		
		<nav class="navbar navbar-default navbar-fixed-bottom dico-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="nav navbar-header pull-right">
					{% if user.is_authenticated %}
						<a class="navbar-text navbar-link pull-right dico-navbar-text" 
							href="/dico/createpetition?backURL=/dico/">Create an Action</a>
					{% endif %}
				</div>
			</div>
		</nav>
		
		<div class="row">
			{% if user.is_authenticated %}
			<div class="col-xs-12 col-md-6 col-md-push-3">
				<label class="control-label table-label">News</label>
				<table id='my_news' class="table table-striped table-condensed full-width-table" max-width="100%">
				{% if news_list %}
					<tbody>
						{% for news_item in news_list %}
						<tr>
							<td width="auto">
								{% if news_item.section == "petition" %}
									<span class="text-muted">This action needs your vote:<br> </span>
								{% endif %}
								{{ news_item.description }} </td>
							<td width="100px">
								<a class="btn btn-link btn-xs" href="/dico/{{ news_item.id }}/petition/">Vote Now
									<span class="glyphicon glyphicon-chevron-right"></span>
								</a>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				{% else %}
					<tr><td>No news at the moment.</td></tr>
				{% endif %}
				</table>
			</div>

			<div class="col-xs-12 col-sm-6 col-md-3 col-md-pull-6">
				<div>
					<div class="row">
						<div class="col-xs-12">
						<label class="control-label table-label">Your Interests</label>
						<a class="btn btn-sm btn-link" href="{% url 'editInterests' %}">Edit</a>
						</div>
					</div>
					{% if my_issue_list %}
						{% for issue in my_issue_list %}
							<div class="row">
								<div class="col-xs-12 issue-container">
									<a class="btn btn-link btn-xs issue-name"
										href="/dico/{{issue.id}}/issue/">{{ issue.name }}
										{% if issue.petition_count > 0 %}
										 <span class="badge">{{issue.petition_count}}</span>
										{% endif %}
									</a>
								</div>
							</div>
						{% endfor %}
					{% else %}
						<div class="row">
							<div class="col-xs-12 issue-container">
								<a class="btn btn-sm btn-link" href="{% url 'editInterests' %}">Express Interests</a>
							</div>
						</div>
					{% endif %}
				</div>
			</div>
			
			<div class="col-xs-12 visible-xs-inline" style="border:0; height:7px">
			</div>

			<div class="col-xs-12 col-sm-5 col-sm-offset-1 col-md-3 col-md-offset-0">
				<div class="dark-column member-column">
					<div class="row">
						<div class="col-xs-12">
							<label class="control-label table-label">Your Members</label>
						</div>
					</div>
					<div>
						{% if member_list %}
							{% for member in member_list %}
								<div class="member-row">
									<a href="{{ member.website }}" target="_blank"">
										<div class="hidden-xs member-title">
											{{ member.title }} {{ member.first_name }} {{ member.last_name }} {{ member.suffix }}
										</div>
										<div class="member-picture">
											<img width="50" src="http://theunitedstates.io/images/congress/original/{{ member.bioguide_id }}.jpg" />
										</div>
										<div class="visible-xs-inline-block member-title">
											{{ member.title }} {{ member.first_name }} {{ member.last_name }} {{ member.suffix }}
										</div>
									</a>
								</div>
							{% endfor %}
						{% else %}
							<p>No members are available.</p>
						{% endif %}
					</div>
				</div>
			</div>
			{% else %}
			<div class="col-xs-12 help block">
				<a href="{% url 'signin' %}">Sign in</a> to identify the issues you care about and vote on actions
				Congress can take!
			</div>
			<div class="col-xs-12 help block">
	  			Don't have an account? <a href="{% url 'createConstituent' %}?back={% url 'index' %}">Create one now.</a>
			</div>
			{% endif %}
		</div>

		<div class="row">
				<hr class="separator-bold" />
		</div>
		<div class="row">
			{% if issue_list %}
			<div class="col-xs-7 col-sm-7">
				<div class="map-select-column">
					<label for="issue_select" class="control-label">Where People Care About</label>
					<select id="issue_select" class="form-control">
					</select>
				</div>
			</div>

			{% endif %}
			<div class="col-xs-4 map-options-column">
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byDistrictRadio" value=districtScope checked /> by District
				</label>
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byStateRadio" value=stateScope /> by State
				</label>			
			</div>
		</div>


		<div class="row">
			<div id="mapFrame" class="col-xs-12"> </div>
			<div class="col-xs-7 col-sm-8 col-md-9">
				<label id="district_label" for="district_span" class="control-label">District:</label> 
				<span id="district_span"></span><br>
				<label for="my_score" id="my_label" class="control-label">Table</label> <span id="my_score"></span>
			</div>
		</div>

</div> <!-- container -->
</body>