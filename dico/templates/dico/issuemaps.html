<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>I Do Declare</title>

    <!-- Bootstrap -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "dico/css/dicopage.css" %}" rel="stylesheet">
    <link href="{% static "dico/css/mapus.css" %}" rel="stylesheet">
    <link href="{% static "dico/css/index.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

	<!-- Styles for this web page -->
	<style>
	</style>
  </head>
  <body class="dico-two-nav-container">
	<div id='container' class="container-fluid">
		<nav class="navbar navbar-default navbar-fixed-top dico-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="nav navbar-header pull-left">
				  <div class="navbar-brand">I Do Declare</div>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				{% if user.is_authenticated %}
					<div class="nav navbar-nav navbar-header pull-right">
						<li class="dropdown">
						  <a href="#" class="dropdown-toggle navbar-link" data-toggle="dropdown">{{ user.get_full_name }}<span class="caret"></span></a>
						  <ul class="dropdown-menu dropdown-menu-right" role="menu">
							<li><a id="id_accountSettingsLink">Account Settings</a></li>
							<li><a id="id_changePasswordLink">Change Password</a></li>
							<li class="divider"></li>
							<li><a id="id_editInterestsLink">Edit Interests</a></li>
							<li class="divider"></li>
							<li><a href="{% url 'signout' %}">Sign out</a></li>
						  </ul>
						</li>
					</div>
				{% else %}
					<div class="nav navbar-header pull-right">
						<a class="navbar-text navbar-link pull-right dico-navbar-text" href="{% url 'signin' %}">Sign in</a>
					</div>
				{% endif %}
			</div>
		</nav>
		
		<nav class="navbar navbar-default navbar-fixed-bottom dico-navbar" role="navigation">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="nav navbar-header pull-right">
					{% if user.is_authenticated %}
						<a id="id_createActionLink" class="navbar-text navbar-link pull-right dico-navbar-text">Create an Action</a>
					{% endif %}
				</div>
			</div>
		</nav>
		
		<div class="row">
			<div class="col-xs-12 col-md-6 col-md-push-3">
				<label class="control-label table-label">News</label>
				<table id='my_news' class="table table-striped table-condensed full-width-table" max-width="100%">
				{% if news_list %}
					<tbody>
						{% for news_item in news_list %}
						<tr>
							<td width="auto">
								{% if news_item.section == "petition" %}
									<span class="text-muted">This action needs your vote:<br> </span>
								{% endif %}
								{{ news_item.description }} </td>
							<td width="100px">
								<span class="btn btn-link btn-xs petition-news-item" petition="{{ news_item.id }}">Vote Now
									<span class="glyphicon glyphicon-chevron-right"></span>
								</span>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				{% else %}
					<tr><td>No news at the moment.</td></tr>
				{% endif %}
				</table>
			</div>

			<div class="col-xs-12 col-sm-6 col-md-3 col-md-pull-6">
				<div>
					<div class="row">
						<div class="col-xs-12">
							<label class="control-label table-label">Your Interests</label>
						</div>
					</div>
					{% if my_issue_list %}
						{% for issue in my_issue_list %}
							<div class="row">
								<div class="col-xs-12 issue-container">
									<a class="btn btn-link btn-xs issue-name"
										href="/dico/{{issue.id}}/issue/">{{ issue.name }}
										{% if issue.petition_count > 0 %}
										 <span class="badge">{{issue.petition_count}}</span>
										{% endif %}
									</a>
								</div>
							</div>
						{% endfor %}
					{% else %}
						<div class="row">
							<div class="col-xs-12 issue-container">
								<a id="id_expressInterestsLink" class="btn btn-sm btn-link">Express Interests</a>
							</div>
						</div>
					{% endif %}
				</div>
			</div>
			
			<div class="col-xs-12 visible-xs-inline" style="border:0; height:7px">
			</div>

			<div class="col-xs-12 col-sm-5 col-sm-offset-1 col-md-3 col-md-offset-0">
				<div class="dark-column member-column">
					<div class="row">
						<div class="col-xs-12">
							<label class="control-label table-label">Your Members</label>
						</div>
					</div>
					<div>
						{% if member_list %}
							{% for member in member_list %}
								<div class="member-row">
									<a href="{{ member.website }}" target="_blank"">
										<div class="hidden-xs member-title">
											{{ member.title }} {{ member.first_name }} {{ member.last_name }} {{ member.suffix }}
										</div>
										<div class="member-picture">
											<img width="50" src="http://theunitedstates.io/images/congress/original/{{ member.bioguide_id }}.jpg" />
										</div>
										<div class="visible-xs-inline-block member-title">
											{{ member.title }} {{ member.first_name }} {{ member.last_name }} {{ member.suffix }}
										</div>
									</a>
								</div>
							{% endfor %}
						{% else %}
							<p>No members are available.</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<div class="row">
				<hr class="separator-bold" />
		</div>
		<div class="row">
			{% if issue_list %}
			<div class="col-xs-7 col-sm-7">
				<div class="map-select-column">
					<label for="issue_select" class="control-label">Where People Care About</label>
					<select id="issue_select" class="form-control">
					</select>
				</div>
			</div>

			{% endif %}
			<div class="col-xs-4 map-options-column">
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byDistrictRadio" value=districtScope checked /> by District
				</label>
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byStateRadio" value=stateScope /> by State
				</label>			
			</div>
		</div>

		<div class="row">
			<div id="mapFrame" class="col-xs-12"> </div>
			<div class="col-xs-7 col-sm-8 col-md-9">
				<label id="district_label" for="district_span" class="control-label">District: </label> 
				<span id="district_span"></span><br>
				<label for="id_constituent_table" id="my_label" class="control-label">By the numbers</label>
				<table id='id_constituent_table' class="table table-striped table-condensed">
					<thead>
						<th id="id_constituent_area_label">District
						</th>
						<th>Count
						</th>
					</thead>
					<tbody id='id_constituent_table_body'>
					</tbody>
				</table>
			</div>
		</div>

	</div> <!-- container -->
</body>

    <!-- Scripts for data mapping --!>
    <script src="{% static "d3/d3.v3.min.js" %}"></script>
    <script src="{% static "d3/queue.v1.min.js" %}"></script>
    <script src="{% static "d3/topojson.v1.min.js" %}"></script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="{% static "jquery/js/jquery.min.js" %}"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
    <script src="{% static "jquery/js/spin.min.js" %}"></script>
    
    <script src="{% static "dico/js/mapus.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">				
		function htmlDecode(input){
		  var e = document.createElement('div');
		  e.innerHTML = input;
		  return e.childNodes[0].nodeValue;
		}

		function htmlEncode(input){
			str = $('<div>').text(input).html();
		    return String(str).replace(/ /g, '&nbsp;');
		}
		
		$(document).ready (function() {
			var encodedRef = encodeURIComponent(window.location.href);
			$("#id_accountSettingsLink").attr("href", "{% url 'account' %}?back="+encodedRef);
			$("#id_changePasswordLink").attr("href", "{% url 'password' %}?back="+encodedRef);
			$("#id_editInterestsLink").attr("href", "{% url 'editInterests' %}?back="+encodedRef);
			$("#id_expressInterestsLink").attr("href", "{% url 'editInterests' %}?back="+encodedRef);
			$("#id_createActionLink").attr("href", "{% url 'createPetition' %}?back="+encodedRef);
			
			$(".petition-news-item").click(function(e) {
				window.location.href="/dico/" + $(this).attr("petition") + "/petition/?backURL="+encodedRef+";backName=Home"
			});

			initmap("#mapFrame", "{% static "dico/us.json" %}");
			
			show_issue_map();

			addHandlers();
		});

		$(window).resize(function() {
		  	resize_interest_map();
		});
		
		function addHandlers() {
		  $("#issue_select").change( function() { 
		  	change_issue($("#issue_select").val(), getscope()) 
		  });
		  $("#byDistrictRadio").change( function() {
		  	show_interest_map(districtScope);
		  });
		  $("#byStateRadio").change( function() { 
		  	show_interest_map(stateScope);
		  });
		}
		

		function change_issue(newIssue, newScope) {
		  $.getJSON("{% url 'getIssueInterests' %}", { pk: newIssue, scope : newScope}, function(json){
			var s = "";
			if (json['error']) {
				s = json['error'];
				console.log(s);
				alert(s);
			} else {
				mapdatapoints("#mapFrame", 
							  "#id_constituent_area_label", 
							  "#id_constituent_table_body", 
							  newScope, 
							  json['interests'],
							  'constituent_count');
			}
		  });
		}

		function show_my_interests() {
		  $.post("{% url 'getMyInterests' %}", { csrfmiddlewaretoken: '{{ csrf_token }}'}, function(json){
			
			{% if user.is_authenticated %}
				$("#my_interests").empty();
				ul = document.createElement( "tbody" );
				$("#my_interests").append(ul);
				
				var issues = json['myIssues'];
				for (i = 0; i < issues.length; ++i) {
					issue = issues[i];
					tr = document.createElement("tr");
					td1 = document.createElement("td");
					td2 = document.createElement("td");
					newButton = document.createElement("a");
					$(ul).append(tr);
					$(tr).append(td1)
						 .append(td2);
					$(td1).append(newButton);
					$(newButton).addClass("btn btn-link btn-xs")
								.attr("href", "/dico/" + issue['id'] + "/issue/")
								.append(htmlEncode(issue['name']));
					petitionCount = parseInt(issue['petition_count']);
					if (petitionCount > 0) {
						newBadge = document.createElement("span");
						$(newBadge).addClass("badge")
								   .append(petitionCount);
						$(newButton).append(" ")
								    .append(newBadge);
					}
					newButton = document.createElement("a");
					newSpan = document.createElement("span")
					$(td2).append(newButton);
					$(newButton).attr("href", "/dico/" + issue['id'] + "/issue/")
								.append(newSpan);
					$(newSpan).addClass("glyphicon glyphicon-chevron-right");
				}
			{% endif %}

			show_issue_map();
			
		  });
		}
		
		function show_issue_map() {
		  	$.getJSON("{% url 'getIssues' %}", { 'minInterestCount': 1}, function(json){
				var allIssues = json['issues'];

				selectElement = document.getElementById("issue_select")
	
				// Add an option for each issue to the select object.
				for (i = 0; i < allIssues.length; ++i) {
					newOption = document.createElement('option');
					newOption.innerHTML = allIssues[i].name;
					newOption.value = allIssues[i].id;
					selectElement.appendChild(newOption);
				}
				show_interest_map(getscope());
			});
		}
		
		function resize_interest_map() {
			resizemap("#mapFrame");			
			show_interest_map(getscope());
		}
		
		function getscope() {
		  	if ($("#byDistrictRadio").prop("checked")) { 
		  		return districtScope;
		  	} else {
		  		return stateScope;
		  	}
			
		}
		
		function show_interest_map(newScope)
		{
			show_map("#mapFrame", $("#district_label"), $("#district_span"), 
					 "{% static "dico/us.json" %}",
					 "{% static "dico/us-congress-113.json" %}",
					 function() {change_issue($("#issue_select").val(), newScope); }, 
					 newScope);
		}
		
		initmapheight("#mapFrame");
	</script>

