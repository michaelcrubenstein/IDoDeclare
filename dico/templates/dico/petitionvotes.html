<!DOCTYPE html>
<html lang="en">
{% load staticfiles %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>I Do Declare - Votes</title>

    <!-- Bootstrap -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{% static "dico/css/dicopage.css" %}" rel="stylesheet">
    <link href="{% static "dico/css/mapus.css" %}" rel="stylesheet">
    <link href="{% static "dico/css/petition.css" %}" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Scripts for data mapping --!>
    <script src="{% static "d3/d3.v3.min.js" %}"></script>
    <script src="{% static "d3/queue.v1.min.js" %}"></script>
    <script src="{% static "d3/topojson.v1.min.js" %}"></script>

	<!-- Styles for this web page -->
	<style>

	</style>


  </head>
  <body>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
    <script src="{% static "jquery/js/spin.min.js" %}"></script>

    <script src="{% static "dico/js/mapus.js" %}"></script>

	<!-- Scripts for this web page -->
	<script type="text/JavaScript">
	
		var deferredObject;

		// Display all of the interests in the system.
		var storedcsrftoken = "{{ csrf_token }}";

		$(document).ready (function(e) {
			<!-- Block of code for an alert area at the top of the window -->
			$(".close").click(function(){
				$(this).parent().alert();
			});
			
			bootstrap_alert = function() {}
			bootstrap_alert.show = function(parentDiv, message, alertClass) {
				parentDiv.html('<div class="alert ' + alertClass + ' alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><span>'+message+'</span></div>')
			}
			bootstrap_alert.warning = function(message) {
				bootstrap_alert.show($('#myAlert'), message, "alert-danger");
			}
        	closealert = function() { 
        		$('.alert').parent().html('');
        	}
        	
			$("#done_button").click(function(e) {
				var backURL = encodeURIComponent("{{backURL}}");
				var backName = encodeURIComponent("{{backName}}");
				window.location.href = "/dico/{{petition.id}}/petition/?backURL="+backURL+";backName="+backName;
				e.preventDefault();
			});

			$("#id_new_argument_text").focus();
		});

		$(document).ready (function() {
			encodedRef = encodeURIComponent(window.location.href);
			$("#id_accountSettingsLink").attr("href", "{% url 'account' %}?back="+encodedRef);
			$("#id_changePasswordLink").attr("href", "{% url 'password' %}?back="+encodedRef);
			$("#id_editInterestsLink").attr("href", "{% url 'editInterests' %}?back="+encodedRef);

			initmap("#mapFrame", "{% static "dico/us.json" %}");
			
			show_vote_map(getscope());

			addHandlers();
		});

		$(window).resize(function() {
		  	resize_interest_map();
		});
		
		function addHandlers() {
			$("#id_supportRadio").change( function() {
				change_vote($(this).val(), getscope());
			});
			$("#id_opposeRadio").change( function() {
				change_vote($(this).val(), getscope());
			});
			$("#byDistrictRadio").change( function() {
				show_vote_map(districtScope);
			});
			$("#byStateRadio").change( function() { 
		  		show_vote_map(stateScope);
			});
		}
		

		function change_vote(newVote, newScope) {
		  $.getJSON("{% url 'getPetitionVotesByScope' %}", { petition: {{ petition.id }}, scope : newScope}, function(json){
			var s = "";
			if (json['error']) {
				s = json['error'];
				console.log(s);
				alert(s);
			} else {
				var vote;
				if (newVote == $("#id_supportRadio").val())
					vote = 'support_count';
				else
					vote = 'oppose_count';
				mapdatapoints("#mapFrame", 
							  "#id_constituent_area_label", 
							  "#id_constituent_table_body", 
							  newScope, 
							  json['votes'],
							  vote);
			}
		  });
		}

		function resize_interest_map() {
			resizemap("#mapFrame");			
			show_vote_map(getscope());
		}
		
		function getscope() {
		  	if ($("#byDistrictRadio").prop("checked")) { 
		  		return districtScope;
		  	} else {
		  		return stateScope;
		  	}
			
		}
		
		function show_vote_map(newScope)
		{
			show_map("#mapFrame", $("#district_label"), $("#district_span"), 
					 "{% static "dico/us.json" %}",
					 "{% static "dico/us-congress-113.json" %}",
					 function() {change_vote($('input[name="voteOptions"]:checked').val(), newScope); }, 
					 newScope);
		}
		
		initmapheight("#mapFrame");
	</script>

	<div id='container' class="container-fluid">
		<nav class="navbar navbar-default navbar-fixed-top dico-navbar" role="navigation">
			<div class="container-fluid">
				<ul class="nav navbar-header pull-left">
					<span id="done_button" class="navbar-text navbar-link pull-left dico-navbar-text" href="{{ backURL }}">
						<span class="glyphicon glyphicon-chevron-left"></span>Done
					</span>
				</ul>
				
				<!-- Collect the nav links, forms, and other content for toggling -->
				{% if user.is_authenticated %}
					<ul class="nav navbar-nav navbar-header pull-right">
						<li class="dropdown">
						  <a href="#" class="dropdown-toggle navbar-link" data-toggle="dropdown">{{ user.get_full_name }}<span class="caret"></span></a>
						  <ul class="dropdown-menu dropdown-menu-right" role="menu">
							<li><a id="id_accountSettingsLink">Account Settings</a></li>
							<li><a id="id_changePasswordLink">Change Password</a></li>
							<li class="divider"></li>
							<li><a id="id_editInterestsLink">Edit Interests</a></li>
							<li class="divider"></li>
							<li><a href="{% url 'signout' %}">Sign out</a></li>
						  </ul>
						</li>
					</ul>
				{% else %}
					<ul class="nav navbar-header pull-right">
						<a class="navbar-text navbar-link pull-right dico-navbar-text" href="{% url 'signin' %}">Sign in</a>
					</ul>
				{% endif %}
			</div>
		</nav>

		<div class="row">
	    	<div id="myAlert" class="col-xs-12"></div>
		</div>

		<div class="row">
			<div class="col-xs-12 col-sm-8">
				<h5 id='id_petition_title' class="toplabel">An Action for Congress:</h5>
				<p class="lead"><strong>{{petition.description}}</strong></p>
			</div>
		</div>
			
		<div class="row">
				<hr class="separator-bold" />
		</div>
		<div class="row">
			<div class="col-xs-4 map-options-column">
				<label class="radio-inline">
				  <input type="radio" name="voteOptions" id="id_supportRadio" value=1 checked /> in Support
				</label>
				<label class="radio-inline">
				  <input type="radio" name="voteOptions" id="id_opposeRadio" value=0 /> in Opposition
				</label>			
			</div>
			<div class="col-xs-4 map-options-column">
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byDistrictRadio" value=districtScope checked /> by District
				</label>
				<label class="radio-inline">
				  <input type="radio" name="scopeOptions" id="byStateRadio" value=stateScope /> by State
				</label>			
			</div>
		</div>


		<div class="row">
			<div id="mapFrame" class="col-xs-12"> </div>
			<div class="col-xs-7 col-sm-8 col-md-9">
				<label id="district_label" for="district_span" class="control-label">District: </label> 
				<span id="district_span"></span><br>
				<label for="id_constituent_table" id="my_label" class="control-label">By the numbers</label>
				<table id='id_constituent_table' class="table table-striped table-condensed">
					<thead>
						<th id="id_constituent_area_label">District
						</th>
						<th>Count
						</th>
					</thead>
					<tbody id='id_constituent_table_body'>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</body>